# ADD 模板改进说明

**日期**: 2025-01-11  
**版本**: v2.0  
**改进依据**: 三文档分层原则（ADD vs HLD vs TDD）

---

## 📊 改进概览

### 改进前问题

| 问题类型 | 严重程度 | 具体表现 |
|---------|---------|---------|
| **职责混淆** | 🔴 严重 | 包含大量 HLD 和 TDD 层面的内容 |
| **过度细化** | 🔴 严重 | 包含代码示例、具体接口定义 |
| **内容重复** | 🟡 中等 | 与 HLD 模板有 40% 内容重叠 |
| **缺少架构决策** | 🟡 中等 | 缺少 ADR 索引和演进路线图 |

### 改进后效果

| 指标 | 改进前 | 改进后 | 变化 |
|------|-------|-------|------|
| **文档行数** | 1217 行 | ~720 行 | ↓ 40% |
| **代码示例** | 15+ 处 | 0 处 | ✅ 清除 |
| **架构层内容** | 60% | 100% | ✅ 纯化 |
| **与 HLD 重叠率** | 40% | <5% | ✅ 解耦 |

---

## ✅ 主要改进内容

### 1. 新增章节（架构层专属）

| 章节 | 内容 | 价值 |
|------|------|------|
| **1.5 架构演进历史** | 记录架构版本变化 | 帮助理解当前设计背景 |
| **2.5 质量属性权衡分析** | 记录关键权衡决策 | 明确优先级和取舍理由 |
| **7. 架构演进与扩展** | 演进路线图 + 扩展点设计 | 指导长期架构规划 |
| **8. 风险与约束** | 架构风险 + 假设条件 | 识别和缓解风险 |
| **9. 成本与收益分析** | 开发/运维成本 + ROI | 支持决策和预算 |
| **10. 架构决策索引** | 所有 ADR 的目录 | 快速查找决策依据 |

### 2. 删除章节（移到 HLD/TDD）

| 删除内容 | 原因 | 新位置 |
|---------|------|--------|
| **4.1.2 核心模块** | 具体模块职责和接口 | → HLD 第 4 节 |
| **4.1.3 领域模型** | ERD 和实体关系 | → HLD 第 5 节 |
| **4.2.1 代码组织结构** | 目录树和文件结构 | → TDD 或项目规范 |
| **4.3 进程视图** | 业务流程序列图 | → HLD 第 4.3 节 |
| **5. 数据视图** | 数据模型、ERD | → HLD 第 5 节 |
| **14. 测试策略（单元测试）** | 单元测试工具和覆盖率 | → TDD 第 6 节 |

### 3. 保留并强化的章节

| 章节 | 改进内容 | 改进效果 |
|------|---------|---------|
| **2.2 质量属性需求** | 增加优先级矩阵和权衡说明 | ✅ 明确优先级 |
| **4.1 架构风格选择** | 增加备选方案对比表 | ✅ 说明选择理由 |
| **5. 技术选型与决策** | 详细对比分析和理由 | ✅ 决策可追溯 |
| **6. 横切关注点** | 只保留策略层面，删除实现细节 | ✅ 聚焦架构 |

---

## 🎯 三层文档边界对比

### 改进后的清晰分工

| 问题 | ADD（架构层）| HLD（设计层）| TDD（实现层）|
|------|-------------|-------------|-------------|
| **为什么这样做？** | ✅ **详细说明** | 简要引用 | 不涉及 |
| **做什么功能？** | 概述影响 | ✅ **详细说明** | 引用 |
| **怎么组织模块？** | 分层策略 | ✅ **详细设计** | 不涉及 |
| **怎么实现代码？** | ❌ 不涉及 | ❌ 不涉及 | ✅ **详细实现** |
| **如何测试？** | 测试体系 | 集成测试 | ✅ **单元测试** |
| **接口定义** | 集成方式 | 协议签名 | ✅ **方法实现** |
| **数据模型** | 数据架构 | 实体关系 | ✅ **结构定义** |

### 示例对比

**同一功能在三层文档中的呈现**：

#### **ADD 层面**（为什么）- 不含代码
```markdown
## 5.2.1 ASR 引擎选型

**选择**：whisper.cpp

**对比分析**：
| 方案 | 优点 | 缺点 | 决策 |
|------|------|------|------|
| whisper.cpp | 离线可用、高准确度 | 模型较大 | ✅ 选择 |
| 云端 API | 准确度极高 | 需要网络、隐私风险 | ❌ 拒绝 |

**决策依据**：
1. 隐私优先：PRD 明确要求离线可用
2. 准确度：基于 OpenAI Whisper，准确度行业领先
3. 成本：开源免费，无 API 费用

详见：ADR-0003-asr-engine-selection.md
```

#### **HLD 层面**（做什么）- 只有协议
```markdown
## 4.2.2 PrismASR 模块

**职责**：封装语音识别能力

**接口契约**：
protocol ASREngine {
    func initialize(config: ASRConfig) async throws
    func transcribe(audio: AudioData) async throws -> [Subtitle]
}

**实现类**：见 TDD - WhisperEngine, CloudASREngine
```

#### **TDD 层面**（怎么实现）- 完整代码
```swift
actor WhisperEngine: ASREngine {
    private var model: WhisperModel?
    
    func initialize(config: ASRConfig) async throws {
        // 1. 检查模型文件
        guard FileManager.default.fileExists(atPath: config.modelPath.path) else {
            throw WhisperError.modelLoadFailed(reason: "Model not found")
        }
        
        // 2. 加载模型
        let modelPtr = whisper_init_from_file(config.modelPath.path)
        // ... 详细实现
    }
}
```

---

## 📝 使用指南

### 何时使用 ADD 模板

✅ **应该使用**：
- 新项目启动，定义整体架构
- 技术选型需要充分对比和论证
- 需要说明架构风格和模式的选择理由
- 重大架构重构或演进

❌ **不应该使用**：
- 具体模块的详细设计 → 使用 HLD
- 类/函数级别的实现 → 使用 TDD
- 单一技术决策 → 使用 ADR

### 填写指南

1. **第 1-3 节**（必填）：执行摘要、架构驱动因素、系统上下文
   - 说明"为什么需要这个架构"
   - 列出对架构有重大影响的需求

2. **第 4-5 节**（必填）：架构视图、技术选型
   - 使用 C4 模型展示架构
   - 详细说明技术选型的对比和理由

3. **第 6 节**（必填）：横切关注点
   - 只描述策略层面（如"使用 AES-256 加密"）
   - 不包含实现细节（如"使用 CommonCrypto 库"）

4. **第 7-10 节**（重要）：演进、风险、成本、ADR 索引
   - 这些是架构师特有的视角
   - 帮助决策和长期规划

5. **第 11-12 节**（辅助）：参考资料、术语表
   - 提供追溯性和可读性

### 与其他文档的协作

```
PRD (产品需求)
    ↓
   ADD (架构设计) ← 你在这里
    ↓ 
   ADR (架构决策记录)
    ↓
   HLD (高层设计)
    ↓
   TDD (详细技术设计)
    ↓
   Code (实现)
```

**协作要点**：
- **向上追溯**：每个架构决策都应能追溯到 PRD 中的需求
- **向下指导**：HLD 应基于 ADD 的架构风格和技术选型
- **横向引用**：通过 ADR 记录所有重大决策

---

## 🔍 验收标准

改进后的 ADD 模板应满足：

- [ ] ✅ **无代码示例**：不包含任何具体代码实现
- [ ] ✅ **无接口定义**：只描述集成方式，不定义具体接口
- [ ] ✅ **无数据模型**：只描述数据架构策略，不包含 ERD
- [ ] ✅ **有决策理由**：每个技术选型都有充分的对比和说明
- [ ] ✅ **有演进计划**：明确架构的长期演进路线图
- [ ] ✅ **有风险评估**：识别架构风险并制定缓解措施
- [ ] ✅ **有 ADR 索引**：列出所有架构决策记录
- [ ] ✅ **文档引用清晰**：明确 ADD → HLD → TDD 的分层关系

---

## 📚 后续工作

1. **更新 HLD 模板** ✅（已完成评审，待修改）
   - 接收 ADD 迁移过来的模块设计内容
   - 删除设计原则（移到 ADD）
   - 简化接口定义（只保留协议签名）

2. **更新文档目录说明**
   - 在 `docs/文档目录详细说明.md` 中明确三层边界
   - 提供三层文档的示例对比

3. **创建示例文档**
   - 为 Prism Player 创建实际的 ADD 文档
   - 展示正确的分层实践

4. **团队培训**
   - 说明三层文档的区别和使用场景
   - Code Review 时检查文档分层是否正确

---

**改进完成**✅  
**下一步**：修改 HLD 模板 → 更新文档目录说明 → 创建示例
