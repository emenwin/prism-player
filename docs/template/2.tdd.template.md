<!-- 
模板名称：TDD/HLD 技术设计文档
适用场景：架构/模块设计时创建
填写指南：
  - 🔴 必填项：第 1-4 节
  - 🟡 可选项：第 8-9 节（如无特殊情况可省略）
  - ⏱️ 预估耗时：4-8 小时
  - 📝 Review 检查清单：架构图清晰、接口定义完整、风险已识别
相关模板：基于 0.prd.template.md 和 1.adr.template.md，输出到 5.task-详细设计.template.md
-->

# 技术设计文档（TDD）模板

- 版本：vX.Y
- 适用范围：iOS / Android / 跨端
- 维护人：@
- 最后更新：YYYY-MM-DD
- 关联 ADR：
  - ADR-000X 标题（链接）— 状态：Accepted — 摘要：一句话影响
  - ADR-000Y 标题（链接）— 状态：Proposed — 摘要：一句话影响
- 关联 PRD：`docs/requirements/prd_vX.Y.md`

## 1. 背景与目标
- 背景：
- 目标（可量化）：
- 范围 / 非目标：
- 约束与前提：平台/法规/硬件/既有架构

## 2. 需求与用例
- 功能需求、非功能需求（性能/能耗/可靠性/可维护性）
- 关键用例/用户旅程、边界与异常用例

## 2.5 设计原则

本系统遵循以下核心设计原则：
- **单一职责**：每个模块专注单一功能
- **依赖倒置**：高层依赖抽象（协议）而非具体实现
- **开闭原则**：对扩展开放（例如新 ASR 引擎），对修改封闭
- **MVVM 分层**：严格分离 View/ViewModel/Model
- **测试优先**：核心逻辑测试覆盖率 ≥ 80%
- **[其他项目特定原则]**：[说明]

## 3. 架构总览
- 方案对比与取舍要点（链接到 ADR）
- 逻辑架构图/流程图/时序图/状态机

## 4. 模块与数据设计

### 4.1 模块依赖关系

| 模块 | 依赖 | 禁止依赖 | 说明 |
|------|------|---------|------|
| PrismKit | PrismCore | ❌ PrismASR | 避免 UI 层依赖具体引擎 |
| PrismASR | PrismCore | ❌ PrismKit | 单向依赖，保持模块独立性 |
| Apps | 所有 | - | 应用层可依赖所有模块 |

### 4.2 模块边界与职责
- 模块边界与职责、交互关系、MVVM 映射（SwiftUI/Compose）
- 数据模型、存储设计（模式、索引、迁移策略）
- 关键算法与核心流程（例如离线 ASR 管线、字幕时间同步）

## 5. 接口与集成
- 内部接口（协议/接口定义、错误语义、幂等/重试）
- 外部依赖与库版本、平台能力与权限（音频会话、后台执行）

## 6. 质量与保障

### 6.1 可观测性埋点清单

| 事件 | 类型 | 字段 | 触发条件 | 重要性 |
|------|------|------|---------|--------|
| `asr.transcription.start` | Event | `audioLength`, `language`, `modelId` | 开始转写 | 🔴 P0 |
| `asr.transcription.complete` | Event | `duration`, `segmentCount`, `rtf` | 转写完成 | 🔴 P0 |
| `asr.transcription.error` | Error | `errorCode`, `errorMessage`, `stack` | 转写失败 | 🔴 P0 |
| `[其他事件]` | Event/Error | `[字段]` | `[触发条件]` | 🟡 P1 / 🔵 P2 |

### 6.2 其他质量要求
- 告警与仪表盘
- 性能与容量评估（目标 QPS/吞吐、延迟、内存/CPU/能耗预算）
- 安全与隐私（数据分类、加密、权限）、合规与许可证
- 国际化与本地化策略（避免硬编码字符串）

## 7. 测试与验证
- 测试金字塔（单测/集成/E2E/回归）、测试数据与夹具
- 验收标准、灰度与特性开关

## 8. 交付与运维
- 发布/回滚策略、迁移计划、兼容性（前后向）
- 运维流程与日常操作

## 9. 风险与未决事项
- 风险清单与缓解策略
- 未决问题与跟进计划

## 10. 里程碑与估算
- 版本切片、时间线、依赖关系

## 附录
- 术语表、参考资料、链接索引（含 ADR 索引）

---

**模板版本**: v1.1  
**最后更新**: 2025-10-30  
**变更记录**:
- v1.1 (2025-10-30): 新增设计原则章节、模块依赖矩阵、可观测性埋点清单
- v1.0 (2025-10-24): 初始版本
