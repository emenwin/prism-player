# Architecture Design Document (ADD)

> **文档类型**: 架构设计文档  
> **版本**: v0.1  
> **最后更新**: YYYY-MM-DD  
> **作者**: [作者姓名]  
> **状态**: [Draft | Review | Approved | Deprecated]  
> **受众**: 架构师、技术领导、跨团队协作者

---

## 文档说明

**本文档的定位**：
- **抽象层级**：最高层，聚焦"为什么这样设计"
- **核心内容**：架构风格、技术选型理由、质量属性权衡、系统边界
- **不包含**：具体模块实现、代码示例、详细接口定义（这些在 HLD/TDD 中）
- **关联文档**：
  - 上游：`docs/0_prd/prd_vX.Y.md`（产品需求）
  - 同级：`docs/1_design/architecture/adr/*.md`（架构决策记录）
  - 下游：`docs/1_design/hld/*/hld-*.md`（高层设计）

---

## 文档修订历史

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|---------|
| v0.1 | YYYY-MM-DD | [作者] | 初始版本 |

---

## 1. 执行摘要 (Executive Summary)

### 1.1 文档目的

本文档定义 [系统名称] 的整体架构，说明：
- 架构风格和模式的选择理由
- 关键技术选型的决策依据
- 质量属性的权衡与优先级
- 系统边界与集成策略

**目标读者**：架构师、技术领导、外部系统集成团队

### 1.2 系统概述

[用 2-3 段话描述系统的核心功能、业务价值和技术特点]

**示例**：
> Prism Player 是一款支持实时/离线语音转文字字幕的跨平台音视频播放器。核心价值在于让用户无需网络即可获得高质量的字幕体验，特别适用于学习、会议记录等场景。
>
> 技术上采用模块化架构，核心能力（播放、语音识别、字幕渲染）封装为独立 Package，支持 iOS/macOS/Android 多端复用。语音识别基于 whisper.cpp 本地推理，保证隐私和离线可用性。

### 1.3 关键架构决策

[列出 3-5 个最重要的架构决策，每个一句话概括，详细理由见 ADR]

- **决策 1**：采用模块化架构而非单体应用 → 支持多端复用和独立演进
- **决策 2**：选择 whisper.cpp 作为 ASR 引擎 → 离线可用 + 隐私合规
- **决策 3**：使用 MVVM 架构模式 → 适配 SwiftUI/Compose 声明式 UI
- **决策 4**：[其他关键决策]

**详细决策记录**：见 `docs/1_design/architecture/adr/` 目录

### 1.4 架构目标与约束

**质量属性目标**（按优先级排序）：
1. **性能**：语音转写 RTF < 0.3，UI 响应 < 100ms
2. **隐私**：音频数据本地处理，不上传云端
3. **可维护性**：模块解耦，测试覆盖率 ≥ 80%
4. **可扩展性**：支持新增 ASR 引擎、新平台移植

**技术约束**：
- 移动端平台：iOS 16+, macOS 13+, Android 8+
- 编程语言：Swift（iOS/macOS）, Kotlin（Android）
- UI 框架：SwiftUI, Jetpack Compose（声明式 UI）

**业务约束**：
- 上线时间：[时间要求]
- 团队规模：[人数和技能水平]
- 预算：[开发和运维预算]

**合规约束**：
- 隐私法规：GDPR, CCPA（音频数据处理）
- 开源许可：MIT（whisper.cpp）

### 1.5 架构演进历史

[记录架构的主要版本变化，帮助理解当前设计]

| 版本 | 时间 | 架构变化 | 原因 |
|------|------|---------|------|
| v0.1 | 2025-Q1 | 初始架构：模块化 + whisper.cpp | 新项目启动 |
| v1.0 | [未来] | 增加云端 ASR 备选 | 支持长音频转写 |

---

## 2. 架构驱动因素 (Architecture Drivers)

### 2.1 功能性需求概述

[从 PRD 提炼对架构有重大影响的功能需求，不是全部功能列表]

| 需求ID | 功能描述 | 架构影响 | 优先级 |
|--------|---------|---------|--------|
| FR-001 | 实时语音转字幕 | 需要高性能本地推理引擎 | P0 |
| FR-002 | 离线模式支持 | 不能依赖云端服务 | P0 |
| FR-003 | 多语言支持 | 需要可扩展的引擎切换机制 | P1 |
| FR-004 | 跨平台（iOS/Android） | 需要模块化架构，核心逻辑可复用 | P0 |

**详细功能需求**：见 `docs/0_prd/prd_vX.Y.md`

### 2.2 质量属性需求 (Quality Attributes)

#### 2.2.1 质量属性优先级

[使用权衡矩阵明确各质量属性的重要性]

| 质量属性 | 优先级 | 目标 | 权衡说明 |
|---------|-------|------|---------|
| 🔴 性能 | P0 | RTF < 0.3, UI < 100ms | 核心体验，不可妥协 |
| 🔴 隐私 | P0 | 本地处理，无数据上传 | 合规要求，不可妥协 |
| 🟡 可维护性 | P1 | 测试覆盖 ≥ 80% | 重要但可逐步提升 |
| 🟡 可扩展性 | P1 | 支持新引擎/平台 | 架构设计保证扩展点 |
| 🟢 可用性 | P2 | 目标 99%（本地应用） | 客户端应用，降低要求 |
| 🟢 可伸缩性 | P3 | 不适用（非服务端） | - |

#### 2.2.2 性能 (Performance)

**目标指标**：
- **语音转写延迟**：实时因子 (RTF) < 0.3（即 1 分钟音频 < 18 秒处理）
- **UI 响应时间**：用户操作响应 < 100ms
- **资源占用**：内存峰值 < 150MB，CPU < 20%

**架构策略**：
- 选择高性能本地引擎（whisper.cpp）
- 异步处理架构（避免阻塞 UI）
- 内存管理策略（按需加载模型）

#### 2.2.3 安全性与隐私 (Security & Privacy)

**目标**：
- 音频数据不上传云端（隐私合规）
- 本地存储加密（AES-256）
- 最小权限原则（仅请求必要权限）

**架构策略**：
- 本地推理引擎（whisper.cpp）
- 沙盒存储，应用卸载时清理
- 透明的隐私策略（用户可见数据流向）

#### 2.2.4 可维护性 (Maintainability)

**目标**：
- 代码测试覆盖率 ≥ 80%
- 模块职责清晰（单一职责原则）
- 文档完整（架构 → 设计 → 代码）

**架构策略**：
- 模块化设计（Package 隔离）
- 依赖倒置（抽象协议）
- CI/CD 集成（自动化测试）

#### 2.2.5 可扩展性 (Extensibility)

**目标**：
- 支持新增 ASR 引擎（云端/其他本地引擎）
- 支持新平台移植（如 Windows）
- 支持新功能（如字幕翻译）

**架构策略**：
- 协议/接口抽象（ASREngine, SubtitleProvider）
- 插件化设计（引擎可插拔）
- 核心逻辑与平台代码分离

#### 2.2.6 可移植性 (Portability)

**目标**：
- 核心逻辑跨平台复用（iOS/macOS/Android）
- 平台特定代码最小化

**架构策略**：
- 共享核心 Package（PrismCore, PrismASR）
- 平台适配层（Platform Adapter）

### 2.3 技术约束

**编程语言**：
- iOS/macOS：Swift 5.9+（SwiftUI 要求）
- Android：Kotlin 1.9+（Compose 要求）
- 原生集成：C/C++（whisper.cpp）

**框架限制**：
- UI 框架：SwiftUI（iOS 16+）, Jetpack Compose（Android API 26+）
- 音频处理：AVFoundation（iOS）, MediaCodec（Android）

**基础设施约束**：
- 构建系统：Xcode Cloud（iOS）, GitHub Actions（Android）
- 依赖管理：Swift Package Manager（iOS）, Gradle（Android）

**遗留系统集成**：
- [如有，描述需要集成的遗留系统及约束]

### 2.4 业务约束

- **时间**：MVP 版本需在 [X 个月] 内完成
- **预算**：开发预算 [金额]，无云端服务费用
- **团队**：
  - iOS 开发：[人数] 人
  - Android 开发：[人数] 人
  - 架构设计：[人数] 人

### 2.5 质量属性权衡分析

[记录关键的权衡决策]

| 权衡场景 | 选择 | 放弃 | 理由 |
|---------|------|------|------|
| 本地 vs 云端 ASR | ✅ 本地 | ❌ 云端 | 隐私优先，离线可用 |
| 性能 vs 模型大小 | ⚖️ 平衡 | - | 使用 tiny 模型（39MB）|
| 跨平台 vs 原生 | ✅ 模块化 | ❌ 完全统一 | 核心复用，UI 原生 |


---

## 3. 系统上下文 (System Context)

### 3.1 系统边界

[使用 C4 Context 图展示系统与外部实体的关系，明确系统边界]

```
┌─────────────────────────────────────────────────────────┐
│                    System Context                        │
│                                                          │
│  ┌──────────┐                                            │
│  │   用户   │◄─────────────────┐                         │
│  └────┬─────┘                  │                         │
│       │                        │                         │
│       │ 播放/控制              │ 字幕显示                │
│       ▼                        │                         │
│  ┌─────────────────────────────┴──────────────────────┐ │
│  │         Prism Player (系统边界内)                  │ │
│  │                                                     │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────────────┐ │ │
│  │  │  播放器  │  │语音识别  │  │  字幕渲染        │ │ │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────────────┘ │ │
│  └───────┼─────────────┼─────────────┼───────────────┘ │
│          │             │             │                  │
│          ▼             ▼             ▼                  │
│  ┌────────────┐  ┌─────────────┐  ┌──────────┐        │
│  │ 媒体文件   │  │ ASR 模型    │  │字幕文件  │        │
│  │(本地存储)  │  │(本地文件)   │  │(可选)    │        │
│  └────────────┘  └─────────────┘  └──────────┘        │
│                                                          │
└─────────────────────────────────────────────────────────┘

系统边界说明：
- 边界内：播放、语音识别、字幕渲染（完全本地化）
- 边界外：媒体文件、模型文件（外部输入）
- 无网络依赖：所有功能离线可用
```

### 3.2 外部依赖

[列出系统依赖的外部系统、服务、库]

| 外部实体 | 类型 | 用途 | 通信方式 | 可用性要求 |
|---------|------|------|---------|-----------|
| whisper.cpp | 开源库 | 语音识别引擎 | FFI 调用 | 本地集成，无网络 |
| AVFoundation | 系统框架 | 音频/视频播放 | Native API | iOS/macOS 内置 |
| MediaCodec | 系统框架 | 音频/视频解码 | Native API | Android 内置 |
| 文件系统 | 系统服务 | 媒体/模型存储 | 本地文件访问 | 100% 可用 |

**关键依赖分析**：
- **whisper.cpp**：核心依赖，需静态链接或动态加载
  - 许可证：MIT（兼容商业使用）
  - 版本策略：锁定稳定版本，定期更新
  - 风险缓解：保留上一版本作为回退

### 3.3 用户角色与交互

[定义主要用户角色及其与系统的交互方式]

| 角色 | 描述 | 主要交互场景 |
|------|------|-------------|
| 普通用户 | 使用播放器观看视频 | 播放视频 → 自动生成字幕 → 查看/调整字幕 |
| 学习者 | 用于语言学习、课程记录 | 重复播放 → 字幕导出 → 笔记整理 |
| 会议记录者 | 录音转文字 | 导入音频 → 批量转写 → 导出文本 |

### 3.4 集成策略

[定义系统如何与外部系统集成]

**集成点**：
- **文件系统集成**：通过系统文件选择器导入媒体文件
- **分享集成**：通过系统分享菜单接收其他 App 的音视频
- **导出集成**：字幕导出为 SRT/VTT 格式，可分享到其他 App

**集成原则**：
- 使用系统标准 API（如 Document Picker, Share Sheet）
- 遵循平台设计规范（iOS Human Interface Guidelines, Material Design）
- 无侵入式集成（不要求其他 App 修改）

---

## 4. 架构视图 (Architecture Views)

> **注意**：本节聚焦架构层面的高层视图，不包含具体模块实现细节
> - 具体模块职责 → 见 HLD
> - 接口定义 → 见 HLD
> - 代码结构 → 见 TDD

### 4.1 架构风格选择

**选择**：模块化分层架构 (Modular Layered Architecture)

**理由**：
1. **跨平台复用**：核心逻辑封装为独立 Package，iOS/Android 共享
2. **职责分离**：播放、识别、渲染各自独立，便于并行开发
3. **可测试性**：模块间依赖抽象（协议），便于 Mock 测试
4. **可扩展性**：新增平台或功能，只需添加新模块

**备选方案对比**：

| 方案 | 优点 | 缺点 | 决策 |
|------|------|------|------|
| 单体应用 | 开发简单 | 无法跨平台复用 | ❌ 拒绝 |
| 模块化架构 | 复用性好，可扩展 | 初期复杂度高 | ✅ 选择 |
| 微服务 | 极强扩展性 | 不适合客户端 | ❌ 不适用 |

**详细决策记录**：见 `docs/1_design/architecture/adr/ADR-0001-modular-architecture.md`

### 4.2 分层架构

```
┌─────────────────────────────────────────────────────────┐
│                   Application Layer                      │
│            (Platform-Specific UI & Logic)                │
│      ┌────────────────┐      ┌──────────────────┐      │
│      │ PrismPlayer iOS│      │ PrismPlayer      │      │
│      │    /macOS      │      │    Android       │      │
│      └────────┬───────┘      └────────┬─────────┘      │
└───────────────┼──────────────────────┼─────────────────┘
                │                      │
                ▼                      ▼
┌─────────────────────────────────────────────────────────┐
│              Presentation Layer (Shared)                 │
│                   (UI Components)                        │
│                    ┌──────────┐                         │
│                    │ PrismKit │                         │
│                    └─────┬────┘                         │
└──────────────────────────┼──────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│              Business Logic Layer (Shared)               │
│              ┌──────────┐    ┌──────────┐              │
│              │ PrismASR │    │  Player  │              │
│              │ (语音识别)│    │  Core    │              │
│              └─────┬────┘    └─────┬────┘              │
└────────────────────┼───────────────┼─────────────────────┘
                     │               │
                     ▼               ▼
┌─────────────────────────────────────────────────────────┐
│              Foundation Layer (Shared)                   │
│                    ┌──────────┐                         │
│                    │PrismCore │                         │
│                    │(协议/模型)│                         │
│                    └──────────┘                         │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│              Infrastructure Layer                        │
│         (Platform APIs, File System, Native Libs)       │
└─────────────────────────────────────────────────────────┘
```

**分层说明**：

| 层级 | 职责 | 技术选型 | 可复用性 |
|------|------|---------|---------|
| Application | 平台特定的应用逻辑 | Swift/Kotlin | ❌ 平台独立 |
| Presentation | 跨平台 UI 组件 | SwiftUI/Compose | ✅ 部分复用 |
| Business Logic | 核心业务逻辑 | Swift/Kotlin | ✅ 完全复用 |
| Foundation | 协议定义、数据模型 | Swift/Kotlin | ✅ 完全复用 |
| Infrastructure | 系统 API 封装 | Platform APIs | ❌ 平台独立 |

**依赖规则**：
- 上层依赖下层，禁止反向依赖
- 跨层依赖通过协议（抽象）
- 平台代码不直接依赖业务逻辑实现

### 4.3 模块架构（C4 Container 视图）

```
┌─────────────────────────────────────────────────────────┐
│                    Prism Player System                   │
│                                                          │
│  ┌────────────┐   ┌────────────┐   ┌────────────┐     │
│  │            │   │            │   │            │     │
│  │ PrismKit   │   │ PrismASR   │   │ PrismCore  │     │
│  │            │   │            │   │            │     │
│  │ [UI组件]   │──▶│ [语音识别] │──▶│ [核心协议] │     │
│  │            │   │            │   │            │     │
│  └────────────┘   └────────────┘   └────────────┘     │
│        │                 │                 │            │
│        └─────────┬───────┴─────────────────┘            │
│                  ▼                                       │
│          ┌──────────────┐                               │
│          │ App Container│                               │
│          │ (iOS/Android)│                               │
│          └──────────────┘                               │
└─────────────────────────────────────────────────────────┘
```

**模块说明**（架构层面，不含具体实现）：

| 模块 | 职责（架构层面） | 为什么需要这个模块 |
|------|-----------------|-------------------|
| PrismCore | 定义核心抽象（协议、模型） | 统一各模块的契约，支持跨平台 |
| PrismASR | 语音识别能力封装 | 隔离 ASR 引擎复杂度，支持引擎切换 |
| PrismKit | UI 组件库 | 复用常见 UI 组件，保持设计一致性 |
| App Container | 应用入口和平台集成 | 整合所有模块，提供完整应用体验 |

**注意**：具体模块职责、接口定义见 `docs/1_design/hld/`

### 4.4 部署架构

**部署模型**：独立客户端应用（非 C/S 架构）

```
┌──────────────────────────────────────┐
│         User's Device                │
│                                      │
│  ┌────────────────────────────────┐ │
│  │    Prism Player App            │ │
│  │                                │ │
│  │  ┌──────────┐  ┌────────────┐ │ │
│  │  │ App Binary│  │ ASR Model  │ │ │
│  │  │  (~20MB)  │  │ (~50MB)    │ │ │
│  │  └──────────┘  └────────────┘ │ │
│  │                                │ │
│  │  ┌──────────────────────────┐ │ │
│  │  │  User's Media Files      │ │ │
│  │  │  (Videos/Audios)         │ │ │
│  │  └──────────────────────────┘ │ │
│  └────────────────────────────────┘ │
│                                      │
│  No Network Required                 │
└──────────────────────────────────────┘
```

**部署特点**：
- **完全本地化**：无服务端依赖
- **模型分发**：ASR 模型随应用分发或按需下载
- **数据存储**：用户数据存储在应用沙盒内
- **更新机制**：通过 App Store/Play Store 更新

**环境规划**：

| 环境 | 用途 | 部署方式 |
|------|------|---------|
| Development | 开发调试 | 本地 Xcode/Android Studio |
| Testing | QA 测试 | TestFlight / Firebase App Distribution |
| Production | 正式发布 | App Store / Google Play |

---

## 5. 技术选型与决策 (Technology Selection)

### 5.1 技术栈总览

| 层级 | iOS/macOS | Android | 共同点 | 选型理由 |
|------|-----------|---------|--------|---------|
| UI 框架 | SwiftUI | Jetpack Compose | 声明式 UI | 现代化、高效、跨平台趋势 |
| 编程语言 | Swift 5.9+ | Kotlin 1.9+ | 类型安全 | 官方推荐，生态成熟 |
| ASR 引擎 | whisper.cpp | whisper.cpp | 本地推理 | 高性能、隐私合规、离线 |
| 音频处理 | AVFoundation | MediaCodec | 系统 API | 原生性能最优 |
| 依赖管理 | SPM | Gradle | - | 官方工具 |
| 测试框架 | XCTest | JUnit5 | - | 官方推荐 |

### 5.2 关键技术选型决策

#### 5.2.1 ASR 引擎选型

**选择**：whisper.cpp

**对比分析**：

| 方案 | 优点 | 缺点 | 成本 | 决策 |
|------|------|------|------|------|
| whisper.cpp | • 离线可用<br>• 高准确度<br>• 开源免费 | • 模型较大<br>• 推理耗时 | 免费 | ✅ 选择 |
| 云端 API<br>(Google/Azure) | • 准确度极高<br>• 无本地资源占用 | • 需要网络<br>• 有隐私风险<br>• 按量计费 | $$$$ | ❌ 拒绝 |
| Vosk | • 模型小<br>• 轻量级 | • 准确度低<br>• 多语言支持弱 | 免费 | ❌ 备选 |

**决策依据**：
1. **隐私优先**：PRD 明确要求离线可用，符合 GDPR/CCPA
2. **准确度**：whisper.cpp 基于 OpenAI Whisper，准确度行业领先
3. **成本**：开源免费，无 API 费用
4. **可行性**：已验证技术可行性（见 `docs/1_design/feasibility/`）

**详细决策记录**：`docs/1_design/architecture/adr/ADR-0003-asr-engine-selection.md`

#### 5.2.2 UI 架构模式选型

**选择**：MVVM (Model-View-ViewModel)

**理由**：
- SwiftUI/Compose 天然支持数据绑定
- 分离 UI 逻辑和业务逻辑，便于测试
- 社区最佳实践，生态成熟

**架构模式对比**：

| 模式 | 适用性 | 可测试性 | 复杂度 | 决策 |
|------|-------|---------|--------|------|
| MVC | ❌ 不适合声明式 UI | 低 | 低 | ❌ 拒绝 |
| MVP | ⚠️ 可用但不自然 | 高 | 中 | ❌ 次选 |
| MVVM | ✅ 天然适配 | 高 | 中 | ✅ 选择 |
| MVI | ✅ 适合 Compose | 极高 | 高 | ⚠️ 备选 |

**详细决策记录**：`docs/1_design/architecture/adr/ADR-0002-mvvm-pattern.md`

#### 5.2.3 模块化策略选型

**选择**：Swift Package Manager (iOS) + Gradle Modules (Android)

**理由**：
- 官方工具，集成简单
- 支持本地和远程包
- 构建速度快，依赖管理清晰

**备选方案**：
- CocoaPods：社区方案，但 Apple 推荐 SPM
- Mono-repo：所有代码在一个仓库，不利于模块独立性

### 5.3 技术风险评估

| 技术 | 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|------|---------|
| whisper.cpp | 性能不达标 | 高 | 中 | 已完成性能测试，RTF < 0.3 |
| SwiftUI | iOS 16 以下不支持 | 中 | 低 | 明确支持版本，放弃旧版本 |
| 模型大小 | 安装包过大 | 中 | 高 | 使用 tiny 模型（39MB），按需下载 |

### 5.4 技术债务与改进方向

[记录已知的技术债务和未来改进计划]

| 技术债务 | 影响 | 计划解决时间 |
|---------|------|-------------|
| whisper.cpp 版本老旧 | 可能错过性能优化 | v1.1 升级到最新版 |
| 缺少 CI 自动化测试 | 代码质量风险 | Sprint 2 引入 GitHub Actions |
| 模型未压缩 | 安装包大 | v1.2 使用量化模型 |

---

## 6. 横切关注点 (Cross-Cutting Concerns)

> **注意**：本节只描述策略层面，不包含具体实现细节
> - 具体实现 → 见 HLD/TDD
> - 代码示例 → 见 TDD

### 6.1 安全与隐私策略

#### 6.1.1 隐私保护策略

**原则**：隐私优先（Privacy First）

**策略**：
- **本地处理**：所有音频处理在设备本地完成，不上传云端
- **最小化收集**：仅收集必要的用户数据（播放历史、设置）
- **透明可控**：用户可查看和删除所有本地数据
- **符合法规**：遵守 GDPR, CCPA 等隐私法规

**数据分类**：

| 数据类型 | 敏感级别 | 存储位置 | 加密要求 | 保留策略 |
|---------|---------|---------|---------|---------|
| 音视频文件 | 🔴 高 | 应用沙盒 | AES-256 | 用户控制 |
| 转写字幕 | 🔴 高 | 应用沙盒 | AES-256 | 用户控制 |
| 播放历史 | 🟡 中 | UserDefaults | 无 | 可清除 |
| 应用设置 | 🟢 低 | UserDefaults | 无 | 可重置 |

**权限策略**：
- 按需请求权限（不在启动时批量请求）
- 明确说明权限用途
- 提供无权限的降级功能

#### 6.1.2 数据加密策略

**传输加密**：不适用（无网络传输）

**存储加密**：
- 敏感数据（音频、字幕）使用 AES-256 加密
- 密钥存储在系统 Keychain（iOS）/ KeyStore（Android）
- 应用卸载时自动清除所有数据

### 6.2 可观测性策略

#### 6.2.1 日志策略

**日志级别**：
- DEBUG：开发调试信息（仅开发环境）
- INFO：关键业务流程（如转写开始/完成）
- WARN：异常但可恢复的情况
- ERROR：错误需要用户或开发者关注

**日志内容**：
- ✅ 可记录：操作类型、时间戳、性能指标
- ❌ 禁止记录：用户音频内容、敏感文本

**日志存储**：
- 本地文件，滚动策略（最多保留 7 天或 50MB）
- 用户可导出日志用于故障排查

#### 6.2.2 监控指标

**性能指标**：
- 转写延迟（RTF）
- UI 响应时间
- 内存使用峰值
- 崩溃率

**业务指标**：
- 转写成功率
- 用户活跃度
- 功能使用频率

**监控工具**：
- 客户端：内置性能监控
- 崩溃报告：Firebase Crashlytics / Sentry（匿名化）

### 6.3 错误处理与容错策略

#### 6.3.1 错误分类

| 错误类型 | 处理策略 | 用户体验 |
|---------|---------|---------|
| 用户错误 | 友好提示，引导修正 | Toast/Alert |
| 系统错误 | 记录日志，提供恢复选项 | 重试按钮 |
| 致命错误 | 安全降级，保护数据 | 错误页面 |

#### 6.3.2 容错机制

**重试策略**：
- 网络相关：不适用（无网络依赖）
- 文件读取失败：重试 3 次，指数退避
- 转写失败：提示用户，允许重试

**降级策略**：
- ASR 引擎不可用 → 降级到纯播放模式
- 模型加载失败 → 提示用户下载模型

**熔断策略**：
- 连续 5 次转写失败 → 暂停自动转写，提示用户检查

### 6.4 性能优化策略

#### 6.4.1 资源管理策略

**内存管理**：
- 按需加载 ASR 模型（不在启动时加载）
- 及时释放不用的资源（音频缓冲区）
- 内存压力时自动降级（释放模型）

**CPU 管理**：
- 转写任务使用后台线程，不阻塞 UI
- 限制并发转写数量（最多 2 个）

**存储管理**：
- 转写结果按需存储，提供清理选项
- 临时文件及时清理

#### 6.4.2 性能监控策略

**关键指标**：
- 冷启动时间 < 2s
- 转写 RTF < 0.3
- UI 帧率 ≥ 60fps

**监控方式**：
- 开发阶段：Instruments (iOS) / Profiler (Android)
- 生产环境：内置性能监控，上报匿名数据

### 6.5 国际化与本地化策略

**支持语言**：
- 初期：中文、英文
- 后续：根据用户需求扩展

**本地化内容**：
- UI 文本：所有用户可见文本
- 错误消息：所有提示信息
- 文档：帮助文档

**本地化原则**：
- 所有文本使用国际化 API（NSLocalizedString / stringResource）
- 避免硬编码字符串
- 考虑 RTL 语言（如阿拉伯语）

### 6.6 配置管理策略

**配置分层**：
- 应用配置：编译时确定（App ID, API Key）
- 环境配置：区分 Dev/Test/Prod
- 用户配置：用户可修改的设置

**配置存储**：
- 应用配置：Info.plist / build.gradle
- 用户配置：UserDefaults / SharedPreferences

**配置热更新**：不支持（客户端应用，通过版本更新）

---

## 7. 架构演进与扩展 (Architecture Evolution & Extension)

### 7.1 架构演进路线图

[描述架构的长期演进计划]

| 版本 | 时间 | 架构变化 | 驱动因素 | 风险评估 |
|------|------|---------|---------|---------|
| v0.1 | 2025-Q1 | 初始架构：模块化 + whisper.cpp | 新项目启动 | 低 |
| v1.0 | 2025-Q3 | 增加云端 ASR 备选 | 支持长音频转写 | 中 |
| v2.0 | 2026-Q1 | 支持实时协作字幕编辑 | 团队协作需求 | 高 |

**演进原则**：
- 向后兼容：新版本保持 API 兼容性
- 增量演进：逐步迭代，避免大规模重构
- 数据迁移：提供数据迁移工具和方案

### 7.2 扩展点设计

[定义架构的关键扩展点]

| 扩展点 | 扩展方式 | 示例 | 复杂度 |
|-------|---------|------|--------|
| ASR 引擎 | 实现 ASREngine 协议 | CloudASREngine | 低 |
| 存储后端 | 实现 StorageProvider 协议 | CloudStorage | 中 |
| 导出格式 | 实现 ExportFormat 协议 | PDFExporter | 低 |
| 新平台支持 | 复用核心 Package | Windows 版本 | 高 |

**扩展指南**：
- 所有扩展通过协议/接口实现
- 提供扩展开发文档和示例
- 插件化机制（未来考虑）

### 7.3 技术债务管理

[记录已知的架构层技术债务]

| ID | 描述 | 影响范围 | 优先级 | 计划解决版本 |
|----|------|---------|--------|-------------|
| TD-ARCH-001 | whisper.cpp 版本老旧 | 性能 | P2 | v1.1 |
| TD-ARCH-002 | 缺少模块间通信监控 | 可观测性 | P1 | v1.2 |
| TD-ARCH-003 | 未实现 A/B 测试能力 | 可扩展性 | P3 | v2.0 |

**改进方向**：
- 定期评审技术债务
- 在迭代中分配时间还债
- 防止新债务积累

---

## 8. 风险与约束 (Risks & Constraints)

### 8.1 架构风险评估

| 风险类别 | 具体风险 | 影响 | 概率 | 缓解策略 | 应急计划 | 负责人 |
|---------|---------|------|------|---------|---------|--------|
| 技术风险 | whisper.cpp 性能不达标 | 🔴 高 | 🟡 中 | 已完成POC验证 | 降级到云端API | @架构师 |
| 依赖风险 | whisper.cpp 停止维护 | 🟡 中 | 🟢 低 | 社区活跃，风险低 | Fork 自行维护 | @技术负责人 |
| 平台风险 | iOS/Android API 变更 | 🟡 中 | 🟡 中 | 跟踪官方公告 | 适配层隔离 | @平台负责人 |
| 扩展风险 | 模块化架构复杂度高 | 🟢 低 | 🟡 中 | 完善文档和示例 | 简化模块划分 | @架构师 |

### 8.2 假设条件

**技术假设**：
- [ ] whisper.cpp 在目标设备上性能达标（已验证）
- [ ] 设备存储空间足够（模型 + 音频 ~200MB）
- [ ] 用户设备内存 ≥ 2GB（市场覆盖 95%+）

**业务假设**：
- [ ] 用户接受离线功能（无实时同步）
- [ ] 单次转写时长 < 60 分钟（覆盖 90% 场景）
- [ ] 用户可接受首次下载模型的等待时间

**法规假设**：
- [ ] 本地处理音频符合各国隐私法规
- [ ] 开源许可证（MIT）无商业使用限制

### 8.3 约束条件确认

**平台约束**：
- ✅ iOS 16+, macOS 13+ (SwiftUI 要求)
- ✅ Android 8+ (API 26, Compose 要求)
- ⚠️ 不支持 32 位设备（whisper.cpp 限制）

**资源约束**：
- 团队规模：[当前人数]
- 开发周期：[预计时间]
- 预算：[如有]

---

## 9. 成本与收益分析 (Cost-Benefit Analysis)

### 9.1 开发成本估算

| 阶段 | 工作内容 | 人天 | 风险系数 | 总人天 |
|------|---------|------|----------|--------|
| 架构设计 | ADD/HLD/ADR 编写 | 10 | 1.2 | 12 |
| 核心开发 | PrismCore, PrismASR | 40 | 1.3 | 52 |
| iOS 开发 | PrismPlayer iOS | 30 | 1.2 | 36 |
| Android 开发 | PrismPlayer Android | 30 | 1.2 | 36 |
| 测试与优化 | 测试、性能调优 | 20 | 1.5 | 30 |
| **总计** | | 130 | | **166** |

### 9.2 运维成本（年）

| 项目 | 说明 | 月成本 | 年成本 |
|------|------|--------|--------|
| 云服务 | 不适用（客户端应用） | $0 | $0 |
| CI/CD | GitHub Actions（免费额度） | $0 | $0 |
| 监控 | Firebase（免费额度） | $0 | $0 |
| 人力 | 维护和支持（1 人×20%时间） | [计算] | [计算] |
| **总计** | | | [总计] |

### 9.3 架构决策的收益

| 决策 | 成本 | 收益 | ROI评估 |
|------|------|------|--------|
| 模块化架构 | 初期复杂度 +30% | 跨平台复用代码 60% | 🟢 高 |
| 本地 ASR | 性能优化成本 | 零 API 费用 + 隐私合规 | 🟢 高 |
| MVVM 模式 | 学习曲线 | 可测试性 +40% | 🟡 中 |

---

## 10. 架构决策索引 (ADR Index)

[列出所有相关的架构决策记录，提供快速查找]

| ADR ID | 标题 | 状态 | 日期 | 摘要 | 影响范围 |
|--------|------|------|------|------|---------|
| ADR-0001 | 选择模块化架构 | ✅ Accepted | 2025-01-10 | 支持跨平台代码复用 | 整体架构 |
| ADR-0002 | 采用 MVVM 模式 | ✅ Accepted | 2025-01-10 | 适配声明式 UI 框架 | UI 层 |
| ADR-0003 | 选择 whisper.cpp | ✅ Accepted | 2025-01-15 | 本地推理 + 隐私合规 | ASR 模块 |
| ADR-0004 | 使用 SPM/Gradle | ✅ Accepted | 2025-01-12 | 官方工具，集成简单 | 构建系统 |
| ADR-0005 | 数据本地加密 | ⏳ Proposed | 2025-01-20 | 敏感数据保护 | 存储层 |

**详细 ADR 文档**：见 `docs/1_design/architecture/adr/` 目录

**ADR 编写规范**：见 `docs/template/3.adr.template.md`

---

## 11. 参考资料 (References)

### 11.1 相关文档

- **PRD**：`docs/0_prd/prd_v0.2.md` - 产品需求文档
- **HLD**：`docs/1_design/hld/iOS-macOS/hld-ios-macos-v0.2.md` - 高层设计文档
- **技术可行性**：`docs/1_design/feasibility/technical-feasibility-ios-v0.2.md`
- **Sprint 计划**：`docs/2_scrum/iOS-macOS/sprint-plan-v0.2.md`

### 11.2 技术参考

- [whisper.cpp](https://github.com/ggerganov/whisper.cpp) - ASR 引擎
- [OpenAI Whisper 论文](https://arxiv.org/abs/2212.04356) - 模型原理
- [C4 Model](https://c4model.com/) - 架构图标准
- [ADR (Architecture Decision Records)](https://adr.github.io/) - 决策记录规范

### 11.3 标准与规范

- [iOS Human Interface Guidelines](https://developer.apple.com/design/human-interface-guidelines/)
- [Material Design](https://material.io/design) - Android 设计规范
- [GDPR](https://gdpr.eu/) - 欧盟隐私法规
- [CCPA](https://oag.ca.gov/privacy/ccpa) - 加州隐私法

---

## 12. 术语表 (Glossary)

| 术语 | 全称 | 定义 | 相关章节 |
|------|------|------|---------|
| ADD | Architecture Design Document | 架构设计文档 | 全文 |
| HLD | High-Level Design | 高层设计文档 | 见 docs/1_design/hld/ |
| TDD | Technical Design Document | 详细技术设计文档 | 见 docs/template/2.tdd.template.md |
| ADR | Architecture Decision Record | 架构决策记录 | 第 10 节 |
| ASR | Automatic Speech Recognition | 自动语音识别 | 第 3, 4, 5 节 |
| RTF | Real-Time Factor | 实时因子（处理时间/音频时长） | 第 2, 6 节 |
| MVVM | Model-View-ViewModel | 架构模式 | 第 5 节 |
| SPM | Swift Package Manager | Swift 包管理器 | 第 5 节 |
| POC | Proof of Concept | 概念验证 | 第 8 节 |

---

## 附录 A: 架构评审清单

### A.1 完整性检查

- [ ] 所有功能需求都有对应的架构支持
- [ ] 所有质量属性都有明确的实现策略
- [ ] 所有技术选型都有充分的理由和对比
- [ ] 所有模块都有明确的边界和职责

### A.2 合理性检查

- [ ] 架构风格适合业务场景
- [ ] 技术选型符合团队能力
- [ ] 成本估算合理
- [ ] 风险识别充分

### A.3 可行性检查

- [ ] 技术风险可控
- [ ] 时间预算合理
- [ ] 团队能力匹配
- [ ] 依赖项可获取

### A.4 可维护性检查

- [ ] 架构文档完整清晰
- [ ] 模块职责单一清晰
- [ ] 扩展点设计合理
- [ ] 技术债务可控

### A.5 合规性检查

- [ ] 符合隐私法规（GDPR/CCPA）
- [ ] 开源许可证兼容
- [ ] 平台政策遵守
- [ ] 安全标准满足

---

## 附录 B: 决策日志

[记录架构设计过程中的关键讨论和决策]

| 日期 | 决策内容 | 参与者 | 决策理由 | 后果 |
|------|---------|--------|---------|------|
| 2025-01-10 | 采用模块化架构 | @架构师, @技术负责人 | 支持跨平台复用 | 初期开发复杂度增加 30% |
| 2025-01-15 | 选择 whisper.cpp | @架构师, @AI 专家 | 性能 + 隐私 | 需要优化内存占用 |
| YYYY-MM-DD | [决策内容] | [参与者] | [理由] | [后果] |

---

## 附录 C: 审批记录

| 角色 | 姓名 | 审批意见 | 日期 | 签名 |
|------|------|---------|------|------|
| 架构师 | [姓名] | [意见] | YYYY-MM-DD | |
| 技术负责人 | [姓名] | [意见] | YYYY-MM-DD | |
| 产品负责人 | [姓名] | [意见] | YYYY-MM-DD | |
| iOS 负责人 | [姓名] | [意见] | YYYY-MM-DD | |
| Android 负责人 | [姓名] | [意见] | YYYY-MM-DD | |

---

**文档结束**

> **使用说明**:  
> 1. **定位明确**：本文档是架构层面的"蓝图"，聚焦"为什么"，不包含具体实现
> 2. **下游文档**：具体模块设计见 HLD，代码实现见 TDD
> 3. **持续更新**：架构演进时及时更新本文档，保持一致性
> 4. **定期评审**：每季度或重大变更前进行架构评审
> 5. **配套 ADR**：所有重大决策都应有对应的 ADR 文档

---

**模板版本**: v2.0（基于三文档分层原则重构）  
**最后更新**: 2025-01-11  
**维护**: @架构团队