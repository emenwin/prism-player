# Architecture Design Document (ADD)

> **文档类型**: 架构设计文档  
> **版本**: v0.1  
> **最后更新**: YYYY-MM-DD  
> **作者**: [作者姓名]  
> **状态**: [Draft | Review | Approved | Deprecated]

---

## 文档说明

**本文档的定位**：
- **抽象层级**：最高层，聚焦"为什么这样设计"
- **核心内容**：架构风格、技术选型理由、质量属性权衡、系统边界
- **不包含**：具体模块实现、代码示例、详细接口定义（这些在 HLD/TDD 中）
- **关联文档**：
  - 上游：`docs/0_prd/prd_vX.Y.md`（需求来源）
  - 下游：`docs/1_design/hld/*/hld-*.md`（设计细化）
  - 同级：`docs/1_design/architecture/adr/*.md`（决策记录）

---

## 文档修订历史

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|---------|
| v0.1 | YYYY-MM-DD | [作者] | 初始版本 |

---

## 1. 执行摘要

### 1.1 系统概述

[用 2-3 段话描述系统的核心功能、业务价值和技术特点]

**示例**：
> Prism Player 是一款支持实时/离线语音转文字字幕的跨平台音视频播放器。核心价值在于让用户无需网络即可获得高质量的字幕体验。
>
> 技术上采用模块化架构，核心能力封装为独立 Package，支持 iOS/macOS/Android 多端复用。语音识别基于 whisper.cpp 本地推理，保证隐私和离线可用性。

### 1.2 关键架构决策

[列出 3-5 个最重要的架构决策，详细理由见 ADR]

- **决策 1**：采用模块化架构 → 支持多端复用和独立演进
- **决策 2**：选择 whisper.cpp 作为 ASR 引擎 → 离线可用 + 隐私合规
- **决策 3**：使用 MVVM 架构模式 → 适配 SwiftUI/Compose 声明式 UI
- **决策 4**：[其他关键决策]

**详细决策记录**：见 `docs/1_design/architecture/adr/`

### 1.3 架构目标与约束

**质量属性优先级**：
1. 🔴 **性能**：语音转写 RTF < 0.3，UI 响应 < 100ms
2. 🔴 **隐私**：音频数据本地处理，不上传云端
3. 🟡 **可维护性**：模块解耦，测试覆盖率 ≥ 80%
4. 🟡 **可扩展性**：支持新增 ASR 引擎、新平台移植

**技术约束**：
- 平台：iOS 16+, macOS 13+, Android 8+
- 语言：Swift 5.9+（iOS/macOS）, Kotlin 1.9+（Android）
- UI 框架：SwiftUI, Jetpack Compose

**业务约束**：
- 上线时间：[X 个月]
- 团队规模：[人数]
- 预算：[金额]

---

## 2. 架构驱动因素

### 2.1 功能性需求概述

[从 PRD 提炼对架构有重大影响的功能需求]

| 需求ID | 功能描述 | 架构影响 | 优先级 |
|--------|---------|---------|--------|
| FR-001 | 实时语音转字幕 | 需要高性能本地推理引擎 | P0 |
| FR-002 | 离线模式支持 | 不能依赖云端服务 | P0 |
| FR-003 | 跨平台（iOS/Android） | 需要模块化架构，核心逻辑可复用 | P0 |

### 2.2 质量属性需求

#### 2.2.1 质量属性优先级矩阵

| 质量属性 | 优先级 | 目标 | 架构策略 |
|---------|-------|------|---------|
| 性能 | P0 | RTF < 0.3, UI < 100ms | 高性能引擎 + 异步处理 |
| 隐私 | P0 | 本地处理，无数据上传 | 本地推理 + 沙盒存储 |
| 可维护性 | P1 | 测试覆盖 ≥ 80% | 模块化 + 依赖倒置 |
| 可扩展性 | P1 | 支持新引擎/平台 | 协议抽象 + 插件化 |

#### 2.2.2 质量属性权衡

| 权衡场景 | 选择 | 放弃 | 理由 |
|---------|------|------|------|
| 本地 vs 云端 ASR | ✅ 本地 | ❌ 云端 | 隐私优先，离线可用 |
| 性能 vs 模型大小 | ⚖️ 平衡 | - | 使用 tiny 模型（39MB）|
| 跨平台 vs 原生 | ✅ 模块化 | ❌ 完全统一 | 核心复用，UI 原生 |

### 2.3 技术与业务约束

**技术约束**：
- 编程语言：Swift 5.9+, Kotlin 1.9+
- UI 框架：SwiftUI（iOS 16+）, Jetpack Compose（Android 8+）
- 构建系统：Xcode Cloud, GitHub Actions

**业务约束**：
- 时间：MVP 需在 [X 个月] 内完成
- 团队：iOS [N] 人，Android [N] 人
- 预算：[金额]，无云端服务费用

**合规约束**：
- 隐私法规：GDPR, CCPA
- 开源许可：MIT（whisper.cpp）

---

## 3. 系统上下文

### 3.1 系统边界

[使用 C4 Context 图展示系统与外部实体的关系]

```
┌─────────────────────────────────────────┐
│           System Context                 │
│                                          │
│  用户 ──► Prism Player ──► 本地存储     │
│             │                            │
│             └──► whisper.cpp (本地)      │
│                                          │
│  边界内：播放、语音识别、字幕渲染        │
│  边界外：媒体文件、模型文件              │
│  无网络依赖：所有功能离线可用            │
└─────────────────────────────────────────┘
```

### 3.2 外部依赖

| 外部实体 | 类型 | 用途 | 可用性要求 |
|---------|------|------|-----------|
| whisper.cpp | 开源库 | 语音识别引擎 | 本地集成，无网络 |
| AVFoundation | 系统框架 | 音频/视频播放 | iOS/macOS 内置 |
| MediaCodec | 系统框架 | 音频/视频解码 | Android 内置 |

**关键依赖**：
- **whisper.cpp**：MIT 许可，锁定稳定版本，定期更新

### 3.3 集成策略

**集成点**：
- 文件系统：通过系统文件选择器导入媒体
- 分享功能：通过系统分享菜单接收音视频
- 导出功能：字幕导出为 SRT/VTT 格式

---

## 4. 架构视图

### 4.1 架构风格选择

**选择**：模块化分层架构 (Modular Layered Architecture)

**理由**：
- 跨平台复用：核心逻辑封装为独立 Package
- 职责分离：播放、识别、渲染各自独立
- 可测试性：模块间依赖抽象，便于 Mock 测试
- 可扩展性：新增平台或功能，只需添加新模块

**备选方案对比**：

| 方案 | 优点 | 缺点 | 决策 |
|------|------|------|------|
| 单体应用 | 开发简单 | 无法跨平台复用 | ❌ 拒绝 |
| 模块化架构 | 复用性好，可扩展 | 初期复杂度高 | ✅ 选择 |

**详细决策**：见 `docs/1_design/architecture/adr/ADR-0001-modular-architecture.md`

### 4.2 分层架构

```
┌─────────────────────────────────────────┐
│      Application Layer                  │
│  (Platform-Specific UI & Logic)         │
│  iOS/macOS App | Android App            │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│      Presentation Layer (Shared)        │
│           PrismKit (UI 组件)             │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│      Business Logic Layer (Shared)      │
│  PrismASR (语音识别) | Player Core      │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│      Foundation Layer (Shared)          │
│     PrismCore (协议/模型)                │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│      Infrastructure Layer               │
│  (Platform APIs, Native Libs)           │
└─────────────────────────────────────────┘
```

**分层说明**：

| 层级 | 职责 | 可复用性 |
|------|------|---------|
| Application | 平台特定应用逻辑 | ❌ 平台独立 |
| Presentation | 跨平台 UI 组件 | ✅ 部分复用 |
| Business Logic | 核心业务逻辑 | ✅ 完全复用 |
| Foundation | 协议定义、数据模型 | ✅ 完全复用 |
| Infrastructure | 系统 API 封装 | ❌ 平台独立 |

**依赖规则**：
- 上层依赖下层，禁止反向依赖
- 跨层依赖通过协议（抽象）

### 4.3 模块架构

**核心模块**（架构层面）：

| 模块 | 职责 | 为什么需要 |
|------|------|-----------|
| PrismCore | 定义核心抽象（协议、模型） | 统一各模块契约，支持跨平台 |
| PrismASR | 语音识别能力封装 | 隔离 ASR 引擎复杂度，支持引擎切换 |
| PrismKit | UI 组件库 | 复用 UI 组件，保持设计一致性 |
| App Container | 应用入口和平台集成 | 整合所有模块，提供完整体验 |

**注意**：具体模块职责、接口定义见 HLD

### 4.4 部署架构

**部署模型**：独立客户端应用

```
┌──────────────────────────────────────┐
│         User's Device                │
│  ┌────────────────────────────────┐ │
│  │    Prism Player App            │ │
│  │  • App Binary (~20MB)          │ │
│  │  • ASR Model (~50MB)           │ │
│  │  • User's Media Files          │ │
│  └────────────────────────────────┘ │
│  No Network Required                 │
└──────────────────────────────────────┘
```

**环境规划**：

| 环境 | 用途 | 部署方式 |
|------|------|---------|
| Development | 开发调试 | 本地 IDE |
| Testing | QA 测试 | TestFlight / Firebase |
| Production | 正式发布 | App Store / Play Store |

---

## 5. 技术选型与决策

### 5.1 技术栈总览

| 层级 | iOS/macOS | Android | 选型理由 |
|------|-----------|---------|---------|
| UI 框架 | SwiftUI | Jetpack Compose | 声明式 UI，官方推荐 |
| 编程语言 | Swift 5.9+ | Kotlin 1.9+ | 类型安全，生态成熟 |
| ASR 引擎 | whisper.cpp | whisper.cpp | 高性能、隐私合规、离线 |
| 音频处理 | AVFoundation | MediaCodec | 原生性能最优 |
| 依赖管理 | SPM | Gradle | 官方工具 |
| 测试框架 | XCTest | JUnit5 | 官方推荐 |

### 5.2 关键技术选型决策

#### 5.2.1 ASR 引擎选型

**选择**：whisper.cpp

**对比分析**：

| 方案 | 优点 | 缺点 | 决策 |
|------|------|------|------|
| whisper.cpp | 离线可用、高准确度、免费 | 模型较大、推理耗时 | ✅ 选择 |
| 云端 API | 准确度极高、无本地资源占用 | 需要网络、隐私风险、按量计费 | ❌ 拒绝 |
| Vosk | 模型小、轻量级 | 准确度低、多语言支持弱 | ❌ 备选 |

**决策依据**：
1. 隐私优先：PRD 要求离线可用，符合 GDPR/CCPA
2. 准确度：whisper.cpp 准确度行业领先
3. 成本：开源免费，无 API 费用

**详细决策**：`docs/1_design/architecture/adr/ADR-0003-asr-engine-selection.md`

#### 5.2.2 UI 架构模式选型

**选择**：MVVM (Model-View-ViewModel)

**理由**：
- SwiftUI/Compose 天然支持数据绑定
- 分离 UI 逻辑和业务逻辑，便于测试
- 社区最佳实践

**详细决策**：`docs/1_design/architecture/adr/ADR-0002-mvvm-pattern.md`

### 5.3 技术风险评估

| 技术 | 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|------|---------|
| whisper.cpp | 性能不达标 | 高 | 中 | 已完成 POC 验证 |
| 模型大小 | 安装包过大 | 中 | 高 | 使用 tiny 模型（39MB） |
| SwiftUI | iOS 16 以下不支持 | 中 | 低 | 明确支持版本 |

---

## 6. 横切关注点

### 6.1 安全与隐私策略

**原则**：隐私优先（Privacy First）

**策略**：
- **本地处理**：所有音频处理在设备本地完成，不上传云端
- **数据加密**：敏感数据（音频、字幕）使用 AES-256 加密
- **最小化收集**：仅收集必要的用户数据
- **透明可控**：用户可查看和删除所有本地数据

**数据分类**：

| 数据类型 | 敏感级别 | 存储位置 | 加密 | 保留策略 |
|---------|---------|---------|------|---------|
| 音视频文件 | 高 | 应用沙盒 | AES-256 | 用户控制 |
| 转写字幕 | 高 | 应用沙盒 | AES-256 | 用户控制 |
| 播放历史 | 中 | UserDefaults | 无 | 可清除 |
| 应用设置 | 低 | UserDefaults | 无 | 可重置 |

### 6.2 可观测性策略

**日志策略**：
- **级别**：DEBUG（开发）, INFO（关键流程）, WARN（异常）, ERROR（错误）
- **禁止**：不记录用户音频内容、敏感文本
- **存储**：本地文件，滚动保留 7 天或 50MB

**监控指标**：
- 性能：转写延迟（RTF）、UI 响应时间、内存使用
- 业务：转写成功率、用户活跃度
- 工具：Firebase Crashlytics / Sentry（匿名化）

### 6.3 错误处理与容错策略

**错误分类**：

| 错误类型 | 处理策略 | 用户体验 |
|---------|---------|---------|
| 用户错误 | 友好提示，引导修正 | Toast/Alert |
| 系统错误 | 记录日志，提供恢复选项 | 重试按钮 |
| 致命错误 | 安全降级，保护数据 | 错误页面 |

**容错机制**：
- 文件读取失败：重试 3 次，指数退避
- ASR 引擎不可用：降级到纯播放模式
- 连续失败：熔断保护，暂停自动转写

### 6.4 性能优化策略

**资源管理**：
- 按需加载 ASR 模型（不在启动时加载）
- 及时释放不用的资源（音频缓冲区）
- 内存压力时自动降级（释放模型）

**关键指标**：
- 冷启动时间 < 2s
- 转写 RTF < 0.3
- UI 帧率 ≥ 60fps

### 6.5 国际化策略

**支持语言**：
- 初期：中文、英文
- 后续：根据用户需求扩展

**本地化原则**：
- 所有文本使用国际化 API
- 避免硬编码字符串
- 考虑 RTL 语言支持

---

## 7. 架构演进与扩展

### 7.1 架构演进路线图

| 版本 | 时间 | 架构变化 | 驱动因素 |
|------|------|---------|---------|
| v0.1 | 2025-Q1 | 初始架构：模块化 + whisper.cpp | 新项目启动 |
| v1.0 | 2025-Q3 | 增加云端 ASR 备选 | 支持长音频转写 |
| v2.0 | 2026-Q1 | 支持实时协作字幕编辑 | 团队协作需求 |

### 7.2 扩展点设计

| 扩展点 | 扩展方式 | 示例 | 复杂度 |
|-------|---------|------|--------|
| ASR 引擎 | 实现 ASREngine 协议 | CloudASREngine | 低 |
| 存储后端 | 实现 StorageProvider 协议 | CloudStorage | 中 |
| 导出格式 | 实现 ExportFormat 协议 | PDFExporter | 低 |

### 7.3 技术债务管理

| ID | 描述 | 影响 | 优先级 | 计划版本 |
|----|------|------|--------|---------|
| TD-001 | whisper.cpp 版本老旧 | 性能 | P2 | v1.1 |
| TD-002 | 缺少模块间通信监控 | 可观测性 | P1 | v1.2 |

---

## 8. 风险与约束

### 8.1 架构风险评估

| 风险 | 影响 | 概率 | 缓解策略 | 应急计划 |
|------|------|------|---------|---------|
| whisper.cpp 性能不达标 | 高 | 中 | 已完成 POC 验证 | 降级到云端 API |
| 模块化架构复杂度高 | 低 | 中 | 完善文档和示例 | 简化模块划分 |

### 8.2 假设条件

**技术假设**：
- [ ] whisper.cpp 性能达标（已验证）
- [ ] 设备存储空间足够（~200MB）
- [ ] 用户设备内存 ≥ 2GB

**业务假设**：
- [ ] 用户接受离线功能
- [ ] 单次转写时长 < 60 分钟

### 8.3 约束条件

**平台约束**：
- ✅ iOS 16+, macOS 13+, Android 8+
- ⚠️ 不支持 32 位设备

**资源约束**：
- 团队：[人数]
- 周期：[时间]
- 预算：[金额]

---

## 9. 架构决策索引 (ADR)

| ADR ID | 标题 | 状态 | 日期 | 摘要 |
|--------|------|------|------|------|
| ADR-0001 | 选择模块化架构 | ✅ Accepted | 2025-01-10 | 支持跨平台代码复用 |
| ADR-0002 | 采用 MVVM 模式 | ✅ Accepted | 2025-01-10 | 适配声明式 UI 框架 |
| ADR-0003 | 选择 whisper.cpp | ✅ Accepted | 2025-01-15 | 本地推理 + 隐私合规 |
| ADR-0004 | 使用 SPM/Gradle | ✅ Accepted | 2025-01-12 | 官方工具，集成简单 |

**详细 ADR 文档**：见 `docs/1_design/architecture/adr/`

---

## 10. 参考资料

### 10.1 相关文档

- **PRD**：`docs/0_prd/prd_v0.2.md`
- **HLD**：`docs/1_design/hld/iOS-macOS/hld-ios-macos-v0.2.md`
- **技术可行性**：`docs/1_design/feasibility/`

### 10.2 技术参考

- [whisper.cpp](https://github.com/ggerganov/whisper.cpp)
- [C4 Model](https://c4model.com/)
- [ADR 规范](https://adr.github.io/)

### 10.3 标准与规范

- [iOS Human Interface Guidelines](https://developer.apple.com/design/human-interface-guidelines/)
- [Material Design](https://material.io/design)
- [GDPR](https://gdpr.eu/)

---

## 11. 术语表

| 术语 | 全称 | 定义 |
|------|------|------|
| ADD | Architecture Design Document | 架构设计文档 |
| HLD | High-Level Design | 高层设计文档 |
| ADR | Architecture Decision Record | 架构决策记录 |
| ASR | Automatic Speech Recognition | 自动语音识别 |
| RTF | Real-Time Factor | 实时因子（处理时间/音频时长） |
| MVVM | Model-View-ViewModel | 架构模式 |

---

## 附录：架构评审清单

### 完整性检查
- [ ] 所有功能需求都有对应的架构支持
- [ ] 所有质量属性都有明确的实现策略
- [ ] 所有技术选型都有充分的理由和对比

### 合理性检查
- [ ] 架构风格适合业务场景
- [ ] 技术选型符合团队能力
- [ ] 成本估算合理

### 可行性检查
- [ ] 技术风险可控
- [ ] 时间预算合理
- [ ] 团队能力匹配

### 可维护性检查
- [ ] 架构文档完整清晰
- [ ] 模块职责单一清晰
- [ ] 扩展点设计合理

### 合规性检查
- [ ] 符合隐私法规（GDPR/CCPA）
- [ ] 开源许可证兼容
- [ ] 平台政策遵守

---

**文档结束**

> **使用说明**:  
> 1. **定位明确**：本文档是架构层面的"蓝图"，聚焦"为什么"
> 2. **下游文档**：具体模块设计见 HLD，代码实现见 TDD
> 3. **持续更新**：架构演进时及时更新本文档
> 4. **配套 ADR**：所有重大决策都应有对应的 ADR 文档

---

**模板版本**: v3.0 (精简版)  
**最后更新**: 2025-01-11  
**维护**: @架构团队
