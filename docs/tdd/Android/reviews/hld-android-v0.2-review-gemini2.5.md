# Prism Player Android 高层架构设计（HLD）v0.2 评审报告

> 日期：2025-10-25
> 评审人：GitHub Copilot
> 关联文档：`docs/requirements/prd_v0.2.md`, `docs/tdd/Android/hld-android-v0.2.md`

## 1. 总体评价

**结论：优秀 (Excellent)**

该 HLD 文档质量很高，对 PRD v0.2 的各项需求理解深刻，响应全面。技术选型现代且合理，架构设计清晰、分层明确，具备良好的可扩展性和可测试性。文档不仅覆盖了宏观设计，还深入到了关键流程、数据模型、并发策略、错误处理等重要细节，为后续的开发工作提供了坚实的基础。

## 2. 主要优点

1.  **架构与技术栈先进**：选型（Kotlin, Jetpack Compose, Media3, Hilt, Coroutines, Room）非常贴合现代 Android 开发最佳实践，有利于保证开发效率、代码质量和长期可维护性。MVVM + UseCase 的分层架构是当前社区的主流选择，成熟且健壮。
2.  **PRD 需求覆盖全面**：HLD 细致地回应了 PRD v0.2 的所有核心功能（播放、ASR、翻译、导出）、非功能需求（性能、隐私、i18n、a11y）和关键 KPI 指标。每个设计决策几乎都能在 PRD 中找到依据。
3.  **数据模型设计合理**：`Room` 实体（`SubtitleSegment`, `MediaFile`, `ModelMetadata`, `Settings`）的设计完整地映射了业务需求。特别是为 `SubtitleSegment` 设计复合索引、为 `ModelMetadata` 包含 `sha256` 校验和等细节，体现了对性能和稳定性的深入思考。
4.  **关键流程清晰化**：使用 `mermaid` 序列图清晰地描述了“首帧字幕获取”、“进度拖动抢占”、“字幕翻译”等核心且复杂的流程，逻辑严密，有助于开发团队快速理解和实现。
5.  **细节考虑周全**：文档对并发策略（`Dispatchers` 的使用）、背压与节流、低端设备适配、模型管理（下载/校验/存储）、错误恢复策略等都给出了具体且可行的方案，展现了资深的工程设计能力。

## 3. 发现的问题与建议

虽然 HLD 总体上非常出色，但仍有一些可以进一步明确或优化的点，以使设计更加鲁棒。

### 3.1. 数据模型：字幕轨道区分

-   **现状**：`SubtitleSegment` 实体包含了 `text` 和 `confidence`，但没有明确字段来区分这是“原始 ASR 字幕”还是“翻译字幕”。HLD 序列图暗示通过 `Flow<WindowSegments(translated)>` 在业务逻辑层处理，或保存到“译文轨”。
-   **潜在问题**：如果将原文和译文存在同一张表中，仅靠业务逻辑区分，未来在查询、导出特定轨道、或支持双语显示时会增加复杂性。如果存在不同的表，会增加数据管理的复杂度。
-   **建议**：在 `SubtitleSegment` 表中增加一个 `track` 或 `language_code` 字段。
    -   `track`: `enum { ORIGINAL, TRANSLATED }`
    -   `language_code`: `String` (e.g., "en-US", "zh-Hans")
    这样，所有字幕片段可以存储在同一张表中，通过 `(mediaId, language_code, startMs)` 建立索引，可以非常高效地查询和切换指定语言的字幕轨道，也为未来支持多条翻译轨道（如“中译英”、“中译日”）打下基础。

### 3.2. 后台任务策略明确化

-   **现状**：HLD 提到了使用 `WorkManager` 或 `DownloadManager` 进行模型下载，并提及后台识别会降低频率。
-   **潜在问题**：PRD 7) 要求“应用进入后台时继续识别”。对于 Android 8.0 (API 26) 及以上版本，标准的后台任务有严格的时间限制。长时间的识别任务（如处理一个长视频）若不采取特殊措施，很可能被系统中断。
-   **建议**：明确指出后台识别任务将通过一个与**前台服务 (Foreground Service)** 绑定的 `WorkManager` 任务来执行。当识别任务在后台运行时，应在系统通知栏显示一个持久化通知，告知用户“Prism Player 正在处理字幕...”，并提供暂停/取消操作。这既是满足 Android 系统后台执行限制的规范做法，也为用户提供了透明度和控制权。

### 3.3. 翻译流程的解耦

-   **现状**：字幕翻译流程在序列图中被描述为在 UseCase 层触发，紧跟在 ASR 之后。
-   **潜在问题**：这种紧耦合的设计可能导致 ASR 和翻译的调度不够灵活。例如，如果用户在识别过程中切换了目标翻译语言，处理逻辑会相对复杂。
-   **建议**：将翻译流程设计成一个独立的、可观察的流水线阶段。
    1.  ASR 模块的产物（原始 `SubtitleSegment`）被写入数据库，并标记为 `track = ORIGINAL`。
    2.  一个独立的 `TranslationScheduler` 或 `UseCase` 观察数据库中新增的 `ORIGINAL` 片段。
    3.  根据当前设置（目标语言、是否启用翻译），`TranslationScheduler` 将待翻译的片段放入一个优先级队列，并调用 `Translator` 服务。
    4.  翻译结果（新的 `SubtitleSegment`）被写回数据库，并标记为 `track = TRANSLATED` 和对应的 `language_code`。
-   **理由**：这种设计使得 ASR 和翻译完全解耦，各自负责自己的任务。切换翻译语言只需改变 `TranslationScheduler` 的目标，并可决定是重新翻译已有内容还是仅翻译新内容，逻辑更清晰，系统更具弹性。

### 3.4. “开放问题”的跟进

-   **现状**：HLD 第 19 节提出了一些非常有价值的开放问题，如 ABI 支持范围、模型体积上限等。
-   **建议**：将这些开放问题作为下一个 Sprint Planning 会议的正式议题进行讨论，并做出决策。决策结果应被记录在 `docs/adr` 目录下的新 ADR（Architecture Decision Record）文件中，以便团队成员达成共识并有据可查。

## 4. 结论

本文档是一份高质量、可执行性强的 HLD。上述建议旨在做进一步的增强和明确，并非否定当前设计的合理性。在采纳建议并对开放问题做出决策后，该 HLD 可以作为 Android 端 v0.2 版本开发的权威技术指南。
