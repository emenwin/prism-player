# Prism Player PRD 评审报告

> 评审版本：v0.1（草案）  
> 评审日期：2025-10-17  
> 评审人：AI 架构评审  
> 评审类型：技术架构 + 产品需求评审

---

## 📊 评审总览

| 评审维度 | 评分 | 状态 |
|---------|------|------|
| 需求完整性 | ⭐⭐⭐⭐⭐ | 优秀 |
| 技术可行性 | ⭐⭐⭐⭐ | 良好 |
| 架构设计 | ⭐⭐⭐⭐ | 良好 |
| 非功能需求 | ⭐⭐⭐⭐⭐ | 优秀 |
| 风险控制 | ⭐⭐⭐⭐ | 良好 |
| **综合评价** | **⭐⭐⭐⭐ (4.2/5)** | **建议通过（需补充修订）** |

---

## ✅ 亮点（Strengths）

### 1. **需求定义清晰完整**
- ✓ 明确的目标与成功指标（首帧时间 ≤8s、同步偏差 ≤±200ms、RTF ≥0.5）
- ✓ 清晰的范围定义（In/Out Scope），避免首期功能膨胀
- ✓ 完整的用户故事与验收标准（AC），可直接作为测试基线
- ✓ 术语定义清晰（ASR、RTF、预加载等）

### 2. **技术选型务实可行**
- ✓ iOS (SwiftUI + AVFoundation) 与 Android (Jetpack Compose + ExoPlayer) 选型符合现代最佳实践
- ✓ 本地 ASR 选择 Whisper.cpp 作为首选方案，技术成熟且支持量化
- ✓ 备选方案（Vosk、Core ML）考虑周全，提供降级路径
- ✓ MVVM 架构模式契合移动端开发主流

### 3. **非功能需求覆盖全面**
- ✓ 性能、资源占用、隐私、稳定性、国际化、可访问性全面考虑
- ✓ 隐私优先设计（全程离线、无数据上传）符合当前趋势
- ✓ 国际化与可访问性要求明确（i18n、VoiceOver/TalkBack）

### 4. **工程规范严格**
- ✓ SwiftLint 严格模式 + 禁止硬编码字符串，保证代码质量
- ✓ 模块划分建议清晰（player, extractor, asr, subtitles, settings 等）
- ✓ 分阶段里程碑设计合理（M1-M3，2-4 周迭代）

### 5. **风险识别与缓解**
- ✓ 识别出设备性能差异、法律合规、存储体积等关键风险
- ✓ 提出具体缓解措施（模型档位、降级策略、用户自导入）

---

## ⚠️ 主要问题与建议（Critical Issues）

### 🔴 P0 - 必须解决（Blocker）

#### 1. **性能指标缺乏设备分级定义**
**问题：**
- 文档多处提到"典型设备"、"中端设备"，但未明确定义设备档位
- 首帧时间 ≤8s、RTF ≥0.5 未区分低/中/高端设备的不同目标

**建议：**
```markdown
定义设备性能档位基准：
- **高端设备**（iOS: iPhone 13 Pro+, Android: Snapdragon 888+）
  - 首帧字幕：≤ 5s（Whisper tiny int8）
  - RTF：≥ 1.0（实时或更快）
- **中端设备**（iOS: iPhone 11/12, Android: Snapdragon 778G）
  - 首帧字幕：≤ 8s（Whisper tiny int8）
  - RTF：≥ 0.5（2分钟处理1分钟音频）
- **低端设备**（iOS: iPhone SE 2020, Android: Snapdragon 6 系列）
  - 首帧字幕：≤ 12s（Vosk 小模型或降级）
  - RTF：≥ 0.3（3分钟处理1分钟音频），提示切换更小模型

在设置中提供"性能档位检测"功能，自动推荐模型。
```

#### 2. **模型分发与版权策略不明确**
**问题：**
- 第 15 章提出"是否预置模型？"作为开放问题，但未给出决策
- 模型体积 >100MB，首次运行体验依赖此决策
- 潜在法律风险（模型授权、编解码专利）未形成明确结论

**建议：**
```markdown
**模型分发策略（建议）：**
1. **不预置完整模型**，避免应用体积膨胀与潜在授权问题
2. **内置超轻量 tiny.en-q8 模型**（~40MB），仅支持英文，作为 Demo 体验
3. **首次运行引导用户下载**：
   - 提供应用内下载管理器（从合法镜像源，如 HuggingFace）
   - 支持用户自导入本地模型文件（路径选择器）
   - 提供模型清单（名称、大小、语言、精度对比表）
4. **法律合规**：
   - 在 App Store/Google Play 描述中声明使用 OpenAI Whisper 开源模型（MIT License）
   - 确保解码器使用系统原生库或符合 LGPL 的库（如 FFmpeg shared library）
   - 在"关于"页面提供第三方许可声明

**补充第 6.7 节"模型管理"：**
- 首次启动模型下载引导流程（带进度、断点续传、MD5 校验）
- 模型存储路径：iOS (Library/Models), Android (files/models)
- 提供"删除模型"功能释放空间
```

#### 3. **音频预加载策略与内存管理细节缺失**
**问题：**
- 第 6.2 节提到预加载 10-60s 音频，但未说明内存占用估算与缓冲区管理
- 16kHz 单声道 PCM：60s ≈ 1.92MB（60s × 16000Hz × 2 bytes），可接受
- 但"后台分段：滚动提取与缓存"未明确缓存策略（LRU?上限?）

**建议：**
```markdown
**第 6.2 节补充：音频缓存策略**
- **预加载缓冲区**：当前播放位置 ±30s 窗口（约 60s × 16kHz × 2 = 1.92MB）
- **滚动缓存上限**：≤ 10MB（约 5 分钟音频），超出时 LRU 淘汰
- **内存压力响应**：
  - 收到系统内存警告时，立即释放未播放段的音频缓存
  - 保留当前播放 ±15s 窗口的最小缓存
- **长视频策略**：
  - >1 小时视频采用"按需提取"，不全量加载到内存
  - 已识别字幕持久化到临时文件（JSON/SQLite），避免全内存
```

---

### 🟡 P1 - 强烈建议（Major）

#### 4. **缺少字幕质量评估与用户反馈机制**
**问题：**
- ASR 准确率受设备、模型、音频质量影响大，但缺少用户端质量感知与改进渠道
- 文档提到 WER 作为准确率指标，但用户端无法量化

**建议：**
```markdown
**增加第 6.9 节：字幕质量评估与反馈**
1. **内置质量提示**：
   - 在识别时输出 confidence 分数（如 Whisper 的 avg_logprob）
   - 低置信度片段在 UI 上用不同颜色标记（如浅灰色）
   - 提供"重新识别此段"按钮（用户可选更高精度模型重跑）

2. **用户反馈机制**：
   - 简单的"字幕质量"评分（1-5 星，与模型/设备/语言关联）
   - 可选的"提交问题样本"（匿名上传音频片段 + 错误文本，需用户显式同意）
   - 本地诊断日志导出（包含模型版本、RTF、错误率，不含敏感内容）

3. **性能自适应建议**：
   - 识别 RTF < 0.3 时，主动提示"当前设备处理较慢，建议切换至 tiny 模型"
   - 错误率高时（如连续 3 段 confidence < 0.5），提示检查音频质量或更换模型
```

#### 5. **字幕同步算法与边界情况处理不够详细**
**问题：**
- 第 6.4 节仅说明"与播放器时钟同步渲染"，但未描述算法细节
- 拖动进度、倍速播放、网络抖动（虽是本地，但文件 I/O 可能慢）等场景处理不明

**建议：**
```markdown
**第 6.4 节补充：字幕同步算法**
1. **时钟源**：
   - 统一使用播放器的 currentTime（单调递增，支持倍速）
   - 每帧检查 currentTime 是否在 [segment.startMs, segment.endMs] 范围

2. **同步容差**：
   - 绝对偏差 ≤ ±200ms 时正常显示
   - 偏差 > 200ms 时触发重新对齐（如播放器 seek 后）

3. **边界情况**：
   - **拖动进度（Seek）**：
     - 暂停字幕渲染 → 等待播放器 seekTo 完成 → 查找新位置对应的 segment → 恢复渲染
     - 若该时间点字幕未识别，显示"字幕加载中..."占位符
   - **倍速播放**：
     - 字幕显示时长按倍速等比缩放（如 2x 速度时，字幕停留时间减半）
     - RTF < 倍速时，提示"识别速度跟不上播放，建议降低倍速或切换更快模型"
   - **字幕缺失片段**：
     - ASR 失败或跳过的时间段，不显示字幕（避免错误内容）
     - 提供"重试识别"按钮（手动触发）

4. **性能优化**：
   - 使用二分查找定位当前时间对应的 segment（O(log n)）
   - 预渲染相邻 ±2 个 segment 的文本视图，减少布局抖动
```

#### 6. **国际化（i18n）实现细节不足**
**问题：**
- 第 7/12 章强调"不使用硬编码字符串"，但未说明 i18n 文件组织与命名规范
- ASR 多语言字幕（如中文视频生成中文字幕）与 UI 语言（如英文界面）的关系未明确

**建议：**
```markdown
**第 12 节补充：国际化规范**
1. **iOS (Localizable.strings)**：
   - 文件路径：`Resources/Localization/<language>.lproj/Localizable.strings`
   - 命名规范：`<module>.<feature>.<element>`
     - 示例：`player.control.play`, `subtitle.style.font_size_large`
   - 使用 `NSLocalizedString("key", comment: "说明")`

2. **Android (strings.xml)**：
   - 文件路径：`res/values-<language>/strings.xml`
   - 命名规范：`<module>_<feature>_<element>`
     - 示例：`player_control_play`, `subtitle_style_font_size_large`
   - 使用 `getString(R.string.key)`

3. **语言与字幕的分离**：
   - **UI 语言**：跟随系统设置（Settings.language）
   - **ASR 字幕语言**：独立设置（Settings.asrLanguage），可选"自动检测"或手动指定
   - 示例：用户界面为英文，但识别中文视频生成中文字幕

4. **首期支持语言**：
   - UI：中文（简体）、英文（美国）
   - ASR：中文、英文、日语、韩语（取决于模型，Whisper 支持 99 种语言）
```

---

### 🟢 P2 - 建议优化（Minor）

#### 7. **缺少错误码与诊断日志规范**
**建议：**
- 定义统一的错误码体系（如 `ERR_MEDIA_UNSUPPORTED_FORMAT = 1001`）
- 在第 6.8 节增加"错误码清单"附录
- 明确日志级别（Debug/Info/Warning/Error）与敏感信息脱敏规则

#### 8. **建议补充交互流程说明（用户视角）**
**建议：**
- 第 10 节已有文字流程，可补充简单的用户操作流程说明：
  1. 首次启动 → 模型选择/下载引导（用户决策点）
  2. 选择媒体 → 等待识别 → 观看带字幕视频（成功路径）
  3. 识别失败 → 错误提示 → 重试/切换模型（异常处理）
- **注意**：避免技术实现流程图（如数据流图），应保持用户视角

#### 9. **单元测试覆盖率目标不明确**
**建议：**
- 第 14 节验收标准补充：
  - 核心模块单元测试覆盖率 ≥ 80%（ASR 封装、字幕合并、SRT 导出、时间同步）
  - 集成测试覆盖关键用户路径（E2E）
  - 性能测试：在目标设备上测试首帧时间、RTF（自动化脚本 + 实测数据）

#### 10. **缺少数据迁移与版本兼容性策略**
**建议：**
- 第 9 节增加"数据版本与迁移"小节：
  - 本地数据（设置、模型清单、缓存）使用版本号标记
  - 应用升级时自动迁移旧数据格式
  - 模型文件版本校验（避免不兼容模型导致崩溃）

---

## 🔍 PRD 边界与技术约束评审

### 优点
✅ 技术约束定义合理（MVVM、SwiftLint、i18n）  
✅ 技术选型建议具体且可行（Whisper.cpp、AVPlayer/ExoPlayer）  
✅ 非功能需求量化明确（首帧时间、同步偏差、RTF）

### ⚠️ PRD 边界问题说明
**重要提醒：** 当前 PRD 包含部分技术设计细节（如第 8 节技术选型、第 9 节数据模型、第 12 节模块划分），这些内容传统上属于**技术设计文档（TDD）**的范畴。

对于本项目，这种"混合式 PRD"可以接受，原因是：
1. 技术驱动型产品（ASR 核心能力依赖技术选型）
2. 跨平台开发需要技术约束对齐
3. 团队规模可能较小，不需要严格分离 PRD/TDD

**建议：** 
- 如需严格分离，将第 8/9/12 节抽取为独立的 `TDD.md`（技术设计文档）
- 如维持现状，建议在 PRD 开头增加说明："本文档包含技术约束与初步选型建议，详细技术设计见 TDD.md"

### 不建议在 PRD 中进一步增加的内容
❌ ~~架构图~~（应在 TDD 中）  
❌ ~~依赖注入策略~~（应在 TDD 中）  
❌ ~~线程模型与并发策略~~（应在 TDD 中）  
❌ ~~API 接口设计~~（应在 TDD 中）

这些内容应由技术团队在 **TDD/HLD（High-Level Design）** 文档中补充。

---

## 📋 需求遗漏与补充建议

### 1. **无障碍辅助功能细化**
当前第 11 节仅提到"屏幕阅读器读出播放器控件"，建议补充：
- 字幕内容是否朗读？（避免与原音频冲突，建议提供开关）
- 动态字体大小支持（iOS Dynamic Type、Android sp 单位）
- 高对比度模式（系统设置关联）
- 色盲友好配色方案

### 2. **社交分享与导出场景**
建议在 Out of Scope 中明确：
- 是否支持"分享字幕文件"（通过系统分享菜单）？
- 是否支持"视频 + 字幕烧录导出"（计算量大，建议后期）？

### 3. **后台播放与字幕**
建议明确：
- 应用进入后台时，ASR 任务是否继续？（建议继续，但降低优先级）
- 后台播放时字幕如何处理？（无需渲染，但保留识别）

---

## 🎯 关键决策建议

| 决策点 | 当前状态 | 建议决策 | 理由 |
|--------|---------|---------|------|
| 是否预置完整模型？ | 开放问题 | **否**，仅内置 tiny.en-q8 (~40MB) | 避免应用体积膨胀（>100MB 审核风险）+ 授权清晰 |
| 首选 ASR 引擎？ | Whisper.cpp | **确认 Whisper.cpp** | 技术成熟、社区活跃、支持量化与流式 |
| 模型下载方式？ | 未明确 | 应用内下载 + 用户自导入 | 降低法律风险，提供灵活性 |
| 设备性能分级？ | 未定义 | 定义高/中/低端基准设备 | 明确性能目标，避免"典型设备"歧义 |
| 首期支持语言？ | 中英 | UI: 中英；ASR: 中英日韩 | Whisper 多语言免费，增加竞争力 |
| 字幕编辑功能？ | Out of Scope | **确认排除**（M1-M3） | 首期聚焦播放与生成，避免范围蔓延 |

---

## 📊 风险评估矩阵

| 风险 | 可能性 | 影响 | 等级 | 缓解措施 | 责任人 |
|------|--------|------|------|----------|--------|
| 低端设备性能不达标 | 高 | 高 | 🔴 P0 | 提供 Vosk 降级方案 + 性能档位检测 | 技术负责人 |
| 模型授权与分发问题 | 中 | 高 | 🔴 P0 | 采用 MIT License 模型 + 用户自导入 | 法务 + PM |
| 首帧时间超 8s | 中 | 中 | 🟡 P1 | 优化预加载策略 + Metal/GPU 加速 | iOS 工程师 |
| 存储空间不足（模型 >100MB） | 中 | 中 | 🟡 P1 | 模型按需下载 + 清理工具 | 产品 + 技术 |
| 字幕同步偏差超 ±200ms | 低 | 中 | 🟢 P2 | 严格时钟同步 + 单元测试覆盖 | QA + 开发 |
| iOS App Store 审核拒绝（体积/权限） | 低 | 高 | 🟡 P1 | 不预置大模型 + 明确权限说明 | iOS 负责人 |

---

## ✍️ 具体修订建议清单

### 立即修订（PRD v0.2 必须包含）
1. ✏️ **第 1 节**：补充设备性能分级定义（高/中/低端基准）
2. ✏️ **第 6.2 节**：补充音频缓存策略（上限、LRU、内存压力响应）
3. ✏️ **第 6.4 节**：补充字幕同步算法细节（拖动、倍速、容差）
4. ✏️ **第 6.7 节**：补充模型管理详细流程（下载、导入、删除、校验）
5. ✏️ **第 15 节**：将"模型分发"从开放问题转为明确决策

### 下一版本补充（PRD v0.3）
6. � 补充用户操作流程说明（首次启动、完整播放、错误处理）
7. 📝 补充错误码清单与诊断日志规范
8. 📝 补充单元测试覆盖率目标与验收标准
9. 📝 补充数据版本与迁移策略

### 技术设计文档（TDD.md）- 需单独创建
10. 📐 架构图（分层架构、数据流、模块依赖）
11. 📐 详细技术选型对比与决策依据
12. 📐 API 设计与接口定义
13. 📐 并发模型与线程策略
14. 📐 依赖注入与模块解耦方案

---

## 🎓 PRD 质量改进建议

### 1. **性能指标表达建议**
当前 PRD 已经很好地定义了性能指标，建议在表述时明确"需求"与"技术方案"的边界：

```markdown
✅ PRD 应该写（需求层面）：
- 首帧字幕可见时间 ≤ 8 秒（中端设备）
- 字幕同步偏差 ≤ ±200ms

❌ PRD 不应该写（实现细节）：
- 使用二分查找定位 segment（O(log n)）
- 使用 Metal 加速 Whisper.cpp
→ 这些应该在 TDD.md 中由技术团队决策
```

### 2. **技术约束 vs 技术实现**
当前 PRD 包含的技术内容可以分类处理：

| 内容类型 | 是否适合 PRD | 示例 | 建议 |
|---------|-------------|------|------|
| **技术约束** | ✅ 适合 | "iOS 使用 SwiftUI，Android 使用 Jetpack Compose" | 保留在 PRD |
| **技术选型建议** | ⚠️ 可选 | "优先使用 Whisper.cpp" | 可保留，但标注为"建议" |
| **实现细节** | ❌ 不适合 | "使用 AVAssetReader 解复用" | 移至 TDD.md |
| **架构设计** | ❌ 不适合 | "MVVM 架构，模块划分..." | 移至 TDD.md |

---

## 📌 总结与行动项

### ✅ PRD 整体质量评价
该 PRD 文档是一份**高质量、结构完整**的产品需求文档，展现了：
- 清晰的产品愿景与用户价值主张
- 详尽的功能与非功能需求定义
- 务实的技术约束与选型建议
- 严格的工程规范要求

**文档定位说明：**  
当前 PRD 采用"混合式"风格，包含部分技术设计内容（第 8/9/12 节）。这对技术驱动型产品和敏捷小团队是可接受的，但建议后续将详细技术设计抽离到独立的 **TDD.md** 文档中，保持职责清晰。

### ⚠️ 主要不足
- 部分关键需求细节（性能分级、模型分发决策）需要明确
- 技术约束与实现细节边界可以更清晰
- 缺少明确的用户操作流程说明

### 🚀 建议行动
| 优先级 | 行动项 | 负责人 | 预计时间 |
|--------|--------|--------|----------|
| P0 | 补充设备性能分级定义 | PM + 技术负责人 | 1 天 |
| P0 | 明确模型分发策略与法律合规性 | PM + 法务 | 2 天 |
| P0 | 补充音频缓存与同步算法细节 | PM（需求层面） | 2 天 |
| P1 | 补充用户操作流程说明 | PM | 1 天 |
| P1 | 补充国际化规范与错误处理 | PM + 技术负责人 | 2 天 |
| P2 | 补充单元测试验收标准 | QA + PM | 1 天 |
| - | **创建 TDD.md**（架构图、线程模型等） | 技术负责人/架构师 | 3-5 天 |

### 🎯 下一步
1. 根据评审意见修订 PRD → **v0.2 版本**（预计 3 个工作日）
2. 技术团队创建 **TDD.md**（技术设计文档），包含架构设计、模块划分、API 定义等
3. 组织技术评审会议，确认架构设计方案
4. 启动 M1 原型开发（技术预研 + 核心功能 POC）

---

## 📝 附录：文档分工建议

### PRD vs TDD 职责边界

为了保持文档职责清晰，建议后续按以下方式组织：

#### 📄 PRD.md（产品需求文档）- 由 PM 负责
**核心内容：**
- ✅ 产品目标与用户价值（第 1/4 章）
- ✅ 功能需求与用户故事（第 5/6 章）
- ✅ 非功能需求（性能指标、隐私、国际化等）
- ✅ 验收标准与成功指标
- ✅ 范围定义（In/Out Scope）
- ⚠️ 技术约束（如"必须使用 SwiftUI"，但不涉及实现）

**可选内容：**
- ⚠️ 技术选型建议（如"优先考虑 Whisper.cpp"），但标注为"建议"供技术团队参考

#### 📐 TDD.md（技术设计文档）- 由技术负责人/架构师负责
**核心内容：**
- ✅ 架构设计（分层架构图、模块划分、依赖关系）
- ✅ 技术选型决策与对比分析
- ✅ 数据模型与 API 设计
- ✅ 并发模型与线程策略
- ✅ 性能优化方案（Metal 加速、缓存策略等）
- ✅ 安全与隐私实现方案
- ✅ 测试策略（单元测试、集成测试、性能测试）

#### 📋 项目管理文档
- **Sprint Plan**：迭代计划、任务分解
- **Test Plan**：详细测试用例、测试环境
- **Deployment Guide**：部署流程、发布检查清单

---

## 📚 推荐阅读

### PRD 最佳实践
- [Whisper.cpp GitHub](https://github.com/ggerganov/whisper.cpp)
- [Vosk Offline Speech Recognition](https://alphacephei.com/vosk/)
- [Core ML Whisper Conversion Guide](https://developer.apple.com/machine-learning/core-ml/)

### 移动端 ASR 最佳实践
- [Android MediaExtractor & MediaCodec Guide](https://developer.android.com/guide/topics/media/mediacodec)
- [iOS AVAssetReader Best Practices](https://developer.apple.com/documentation/avfoundation/avassetreader)

### 性能优化参考
- [iOS Metal Performance Shaders](https://developer.apple.com/documentation/metalperformanceshaders)
- [Android NNAPI (Neural Networks API)](https://developer.android.com/ndk/guides/neuralnetworks)

---

**评审结论：建议通过，需补充 P0/P1 问题后发布 v0.2 版本**

**评审签名：** AI 架构评审 @ 2025-10-17  
**下次评审时间：** PRD v0.2 完成后 3 个工作日内
